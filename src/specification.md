# remote-invoke-router 的功能说明与规范

## 连接数
一个模块只能与路由器建立一个连接，之后如果尝试重复连接则会被拒绝，同时"错误计数器" + 1。

## 错误计数器
每个连接都有一个错误计数器，记录着在转发该连接传来的消息的过程中出现了多少次错误。
当错误计数器从0变到1时，启动一个计时器，时长10分钟，过了10分钟则将错误计数器清0。
如果在这10分钟内，错误超过了100次则直接断开连接。

## path
path的最大长度为256个Unicode字符

## 转发调用类型消息
1. 调用类型的消息都是以"invoke"开头的。[详见](https://github.com/mx601595686/remote-invoke/blob/master/src/interfaces/MessageType.ts)    
2. invoke的path是由两部分组成的，例如"namespace/functionName"。中间通过斜线分割，前半部分称为命名空间，后半部分是要调用的方法名。    
3. 要进行一次调用，调用者会发送一条"invoke\_request"消息。路由器在转发时会对该消息的模块名与命名空间进行验证，判断调用者是否有权限调用，以及调用的目标是否存在，如果条件不满足，则消息将被丢弃，同时"错误计数器" + 1。
4. 当转发除"invoke\_request"外的其他类型的调用消息时，需要检查发送者的"可调用白名单"中是否包含接收者的模块名称或接收者的"可调用白名单"中是否包含发送者的模块名称。如果都不满足则丢弃，同时"错误计数器" + 1。

## 转发广播类型消息
1. broadcast的path通过"."来进行分割，第一段是命名空间。例如"namespace.part1.part2"。
2. 路由器在转发某条广播时，首先需要检查的就是，路由器是否向该模块申请过该路径上的广播，如果该模块发来了路由器不需要的广播，则该条消息会被丢弃，并且通知该模块以后不要再发了，同时"错误计数器" + 1。
3. 当某模块向路由器申请要监听某条广播时，路由器先检查该模块申请的广播是否存在于该模块的"可接收广播白名单"中，如果存在则添加到目标模块的"广播接收列表"，如果不存在则添加到该模块的"还不可接收广播列表"，同时"错误计数器" + 1。当哪天该模块的"可接收广播白名单"变化时，"广播接收列表"与"还不可接收广播列表"也需要进行相应变化。